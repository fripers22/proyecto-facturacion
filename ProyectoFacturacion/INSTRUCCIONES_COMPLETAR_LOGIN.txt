# SISTEMA DE LOGIN COMPLETO - PROYECTO FACTURACI√ìN
# INSTRUCCIONES DE IMPLEMENTACI√ìN

## ‚úÖ ARCHIVOS YA CREADOS EN ProyectoFacturacion:

1. **Modelo:**
   - ‚úì Rol.java (NUEVO)
   - ‚úó Usuario.java (REQUIERE ACTUALIZACI√ìN MANUAL)

2. **Repositorio:**
   - ‚úì RolRepositorio.java (NUEVO)
   - ‚úì UsuarioRepositorio.java (ACTUALIZADO)

3. **DTO:**
   - ‚úì UsuarioRegistroDTO.java (NUEVO)

4. **Servicio:**
   - ‚úì CustomUserDetailsService.java (NUEVO)
   - ‚úó UsuarioServicio.java (REQUIERE ACTUALIZACI√ìN MANUAL)

5. **Configuraci√≥n:**
   - ‚úì SecurityConfig.java (NUEVO)

6. **Controladores:**
   - ‚úì AuthControlador.java (NUEVO)
   - ‚úì HomeControlador.java (NUEVO)

7. **Vistas:**
   - ‚úì login.html (NUEVO)
   - ‚úì registro.html (NUEVO)
   - ‚úì acceso-denegado.html (NUEVO)

8. **Base de datos:**
   - ‚úì schema.sql (NUEVO)

9. **Configuraci√≥n:**
   - ‚úì application.properties (ACTUALIZADO)
   - ‚úì pom.xml (YA TIENE LAS DEPENDENCIAS CORRECTAS)

---

## ‚ö†Ô∏è ARCHIVOS QUE NECESITAS ACTUALIZAR MANUALMENTE:

### 1Ô∏è‚É£ Usuario.java

**UBICACI√ìN:** `src/main/java/uts/edu/java/facturacion/modelo/Usuario.java`

**ACCI√ìN:** Reemplaza TODO el contenido del archivo con este c√≥digo:

```java
package uts.edu.java.facturacion.modelo;

import jakarta.persistence.*;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import java.util.HashSet;
import java.util.Set;

@Entity
@Table(name = "usuarios")
public class Usuario {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @NotBlank(message = "El nombre de usuario es obligatorio")
    @Size(min = 3, max = 50)
    @Column(unique = true, nullable = false, length = 50)
    private String username;
    
    @NotBlank(message = "La contrase√±a es obligatoria")
    @Size(min = 6)
    @Column(nullable = false)
    private String password;
    
    @NotBlank(message = "El email es obligatorio")
    @Email(message = "Debe proporcionar un email v√°lido")
    @Column(unique = true, nullable = false)
    private String email;
    
    @Column(nullable = false)
    private String nombre;
    
    @Column(nullable = false)
    private String apellido;
    
    private String cedula;
    
    @Column(nullable = false)
    private boolean enabled = true;
    
    @ManyToMany(fetch = FetchType.EAGER, cascade = CascadeType.ALL)
    @JoinTable(
        name = "usuarios_roles",
        joinColumns = @JoinColumn(name = "usuario_id"),
        inverseJoinColumns = @JoinColumn(name = "rol_id")
    )
    private Set<Rol> roles = new HashSet<>();

    // Constructores
    public Usuario() {
    }

    public Usuario(String username, String password, String email, String nombre, String apellido) {
        this.username = username;
        this.password = password;
        this.email = email;
        this.nombre = nombre;
        this.apellido = apellido;
        this.enabled = true;
    }

    // Getters y Setters
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getNombre() {
        return nombre;
    }

    public void setNombre(String nombre) {
        this.nombre = nombre;
    }

    public String getApellido() {
        return apellido;
    }

    public void setApellido(String apellido) {
        this.apellido = apellido;
    }

    public String getCedula() {
        return cedula;
    }

    public void setCedula(String cedula) {
        this.cedula = cedula;
    }

    public boolean isEnabled() {
        return enabled;
    }

    public void setEnabled(boolean enabled) {
        this.enabled = enabled;
    }

    public Set<Rol> getRoles() {
        return roles;
    }

    public void setRoles(Set<Rol> roles) {
        this.roles = roles;
    }
}
```

---

### 2Ô∏è‚É£ UsuarioServicio.java

**UBICACI√ìN:** `src/main/java/uts/edu/java/facturacion/servicio/UsuarioServicio.java`

**ACCI√ìN:** Reemplaza TODO el contenido del archivo con este c√≥digo:

```java
package uts.edu.java.facturacion.servicio;

import java.util.List;
import java.util.HashSet;
import java.util.Set;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import uts.edu.java.facturacion.dto.UsuarioRegistroDTO;
import uts.edu.java.facturacion.modelo.Rol;
import uts.edu.java.facturacion.modelo.Usuario;
import uts.edu.java.facturacion.repositorio.RolRepositorio;
import uts.edu.java.facturacion.repositorio.UsuarioRepositorio;

@Service
@Transactional
public class UsuarioServicio implements IUsuarioServicio {

    @Autowired
    UsuarioRepositorio usuarioRepositorio;
    
    @Autowired
    private RolRepositorio rolRepositorio;
    
    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public List<Usuario> getUsuarios() {
        return usuarioRepositorio.findAll();
    }

    @Override
    public Usuario nuevoUsuario(Usuario usuario) {
        return usuarioRepositorio.save(usuario);
    }

    @Override
    public Usuario buscarUsuario(Integer id) {
        return usuarioRepositorio.findById(Long.valueOf(id)).orElse(null);
    }

    @Override
    public void borrarUsuario(Integer id) {
        usuarioRepositorio.deleteById(Long.valueOf(id));
    }
    
    // M√âTODOS PARA EL SISTEMA DE LOGIN CON SPRING SECURITY
    
    @Transactional
    public Usuario registrarUsuario(UsuarioRegistroDTO registroDTO) {
        if (usuarioRepositorio.existsByUsername(registroDTO.getUsername())) {
            throw new RuntimeException("El nombre de usuario ya est√° en uso");
        }
        
        if (usuarioRepositorio.existsByEmail(registroDTO.getEmail())) {
            throw new RuntimeException("El email ya est√° registrado");
        }
        
        Usuario usuario = new Usuario();
        usuario.setUsername(registroDTO.getUsername());
        usuario.setPassword(passwordEncoder.encode(registroDTO.getPassword()));
        usuario.setEmail(registroDTO.getEmail());
        usuario.setNombre(registroDTO.getNombre());
        usuario.setApellido(registroDTO.getApellido());
        usuario.setEnabled(true);
        
        Set<Rol> roles = new HashSet<>();
        Rol rolUser = rolRepositorio.findByNombre("ROLE_USER")
                .orElseGet(() -> {
                    Rol nuevoRol = new Rol("ROLE_USER");
                    return rolRepositorio.save(nuevoRol);
                });
        roles.add(rolUser);
        usuario.setRoles(roles);
        
        return usuarioRepositorio.save(usuario);
    }
    
    public Usuario buscarPorUsername(String username) {
        return usuarioRepositorio.findByUsername(username)
                .orElseThrow(() -> new RuntimeException("Usuario no encontrado"));
    }
    
    public boolean existePorUsername(String username) {
        return usuarioRepositorio.existsByUsername(username);
    }
    
    public boolean existePorEmail(String email) {
        return usuarioRepositorio.existsByEmail(email);
    }
}
```

---

## üöÄ PASOS PARA EJECUTAR EL PROYECTO:

### 1. Actualizar archivos manualmente
- Abre `Usuario.java` y reemplaza su contenido con el c√≥digo de arriba
- Abre `UsuarioServicio.java` y reemplaza su contenido con el c√≥digo de arriba

### 2. Actualizar Maven
- Bot√≥n derecho en ProyectoFacturacion ‚Üí Maven ‚Üí Update Project
- Marca "Force Update of Snapshots/Releases"
- Click OK

### 3. Crear/Verificar la base de datos
```sql
CREATE DATABASE IF NOT EXISTS proyecto_facturacion_db;
USE proyecto_facturacion_db;
```

Luego ejecuta el contenido de `src/main/resources/schema.sql`

### 4. Ejecutar la aplicaci√≥n
- Bot√≥n derecho en ProyectoFacturacion ‚Üí Run As ‚Üí Spring Boot App

### 5. Acceder al sistema
- Abrir navegador: http://localhost:8092/login

### 6. Probar el login

**Opci√≥n A: Registrar nuevo usuario**
- Click en "Reg√≠strate aqu√≠"
- Completa el formulario
- Inicia sesi√≥n

**Opci√≥n B: Usuarios de prueba** (si ejecutaste schema.sql)
- Admin: `admin` / `admin123`
- Usuario: `user` / `user123`

---

## üìä CARACTER√çSTICAS IMPLEMENTADAS:

‚úÖ Login seguro con Spring Security 6
‚úÖ Registro de nuevos usuarios
‚úÖ Cifrado de contrase√±as con BCrypt
‚úÖ Validaci√≥n de formularios
‚úÖ Control de acceso basado en roles
‚úÖ Gesti√≥n de sesiones HTTP
‚úÖ Logout con limpieza de sesi√≥n
‚úÖ Mensajes de error y √©xito
‚úÖ Dise√±o responsive moderno
‚úÖ Protecci√≥n CSRF
‚úÖ Prevenci√≥n SQL Injection

---

## üîß PUERTOS CONFIGURADOS:

- ProyectoCorte2: 8090
- ParcialCorte2: 8091
- **ProyectoFacturacion: 8092** ‚úÖ
- ProyectoCorte3: 8093

---

## üìù NOTAS IMPORTANTES:

1. El archivo `pom.xml` ya tiene todas las dependencias necesarias
2. El `application.properties` est√° configurado correctamente
3. JPA crear√° las tablas autom√°ticamente (ddl-auto=update)
4. Puedes ejecutar schema.sql para insertar usuarios de prueba
5. El puerto 8092 est√° libre (cambiado de 8090)

---

## ‚ùó SI HAY ERRORES DE COMPILACI√ìN:

1. Verifica que actualizaste Usuario.java y UsuarioServicio.java
2. Actualiza Maven (Update Project)
3. Limpia el proyecto (Project ‚Üí Clean)
4. Rebuild (Project ‚Üí Build Project)

---

¬°El sistema de login est√° listo en ProyectoFacturacion!
